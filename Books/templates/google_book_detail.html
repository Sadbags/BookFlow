{% extends 'core/base.html' %}

{% block title %}
{{ book.title|default:"Book Details" }}
{% endblock %}

{% block content %}
{% if error %}
<div class="p-6 bg-red-100 text-red-700 rounded">
    {{ error }}
</div>
{% elif book %}
<div class="mt-6 px-6 py-12 bg-gray-100 rounded-xl max-w-6xl mx-auto">

    <!-- Detalle principal del libro -->
    <div class="bg-white shadow-lg rounded-xl overflow-hidden flex flex-col md:flex-row gap-10">

        <!-- Imagen -->
        <div class="w-full md:w-1/3 flex justify-center items-center p-4">
            {% if book.google_id %}
                <img src="{{ book.image }}"
                     alt="{{ book.title }}"
                     class="rounded-lg shadow-md object-contain w-full max-w-[400px] md:max-w-[350px] lg:max-w-[400px] max-h-[500px]">
            {% else %}
                <img src="{{ book.image.url }}"
                     alt="{{ book.title }}"
                     class="rounded-lg shadow-md object-contain w-full max-w-[400px] md:max-w-[350px] lg:max-w-[400px] max-h-[500px]">
            {% endif %}
        </div>

        <!-- InformaciÃ³n -->
        <div class="w-full md:w-2/3 space-y-4 flex flex-col justify-center">

            <h1 class="text-3xl font-bold text-gray-900 leading-tight">{{ book.title }}</h1>
            <p class="text-lg"><strong>Author(s):</strong> {{ book.authors }}</p>
            <p class="text-lg"><strong>Published Date:</strong> {{ book.published_date }}</p>
            <p class="text-lg"><strong>Publisher:</strong> {{ book.publisher }}</p>
            <p class="text-lg"><strong>Categories:</strong> {{ book.categories }}</p>
            <p class="text-lg"><strong>Pages:</strong> {{ book.page_count }}</p>

            <div class="mt-4">
                <h3 class="font-semibold">Description</h3>
                <p class="text-gray-700">{{ book.description|linebreaks }}</p>
            </div>

            <!-- Botones Mark as Read / Readlist -->
            {% if item %}
            <div class="flex flex-row gap-2 mt-4 flex-wrap">
                <form action="{% url 'item:add_google_to_read' item.google_id %}" method="POST">
                    {% csrf_token %}
                    <button type="submit"
                        class="px-6 py-2 text-white font-medium rounded-lg
                        {% if item in request.user.read_books.all %}
                            bg-red-500 hover:bg-red-700
                        {% else %}
                            bg-teal-500 hover:bg-teal-700
                        {% endif %}">
                        {% if item in request.user.read_books.all %}
                            Unmark as Read
                        {% else %}
                            Mark as Read
                        {% endif %}
                    </button>
                </form>

                <form action="{% url 'item:add_google_to_readlist' item.google_id %}" method="POST">
                    {% csrf_token %}
                    <button type="submit"
                        class="px-6 py-2 text-white font-medium rounded-lg
                        {% if item in request.user.readlist_books.all %}
                            bg-red-500 hover:bg-red-700
                        {% else %}
                            bg-teal-500 hover:bg-teal-700
                        {% endif %}">
                        {% if item in request.user.readlist_books.all %}
                            Remove from Readlist
                        {% else %}
                            Add to Readlist
                        {% endif %}
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- Google Preview -->
            {% if book.preview_link %}
            <div class="mt-4 flex justify-start">
                <a href="{{ book.preview_link }}" target="_blank"
                   class="px-5 py-3 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-700">
                   Preview on Google Books
                </a>
            </div>
            {% endif %}

        </div>
    </div>

    <!-- Reviews -->
    {% if request.user.is_authenticated and item %}
    <div class="mt-8 p-6 bg-gray-100 rounded-lg shadow-lg">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">Reviews</h3>
        {% for review in reviews %}
            <div class="p-3 border-b border-gray-200">
                <p><strong>{{ review.user.username }}:</strong> {{ review.comment }}</p>
                <p>Rating: {{ review.rating }}/5</p>
            </div>
        {% empty %}
            <p class="text-gray-500 mt-2">No reviews yet.</p>
        {% endfor %}

        <form method="POST" action="{% url 'item:review' item.id %}" class="mt-4 space-y-4">
            {% csrf_token %}
            <div>
                <label for="id_rating" class="block text-sm font-semibold text-gray-700">Rating (1 to 5 stars)</label>
                <select name="rating" id="id_rating" class="w-full p-3 mt-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500">
                    {% for i in "12345" %}
                        <option value="{{ i }}">{{ i }} Star{% if i != "1" %}s{% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_comment" class="block text-sm font-semibold text-gray-700">Your Review</label>
                <textarea name="comment" id="id_comment" rows="4" class="w-full p-3 mt-2 bg-white border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Write your comments here..."></textarea>
            </div>
            <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-700 mt-4 w-full">
                Submit Review
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Related Books -->
    {% if related_books %}
    <div class="mt-10">
        <h3 class="text-2xl font-bold mb-6">Related Books</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 justify-items-center">
            {% for related in related_books %}
            <a href="{% url 'google_book_detail' %}?id={{ related.google_id }}"
               class="bg-white rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-1 w-full max-w-sm">
                <div class="w-full aspect-[2/3] flex items-center justify-center bg-gray-100 rounded-t-lg overflow-hidden">
                    <img src="{{ related.image }}" class="max-h-full max-w-full object-contain" alt="{{ related.title }}">
                </div>
                <div class="p-4 text-center">
                    <p class="font-semibold text-lg">{{ related.title|truncatechars:40 }}</p>
                    <p class="text-gray-500 text-sm">{{ related.authors }}</p>
                    <p class="text-gray-400 text-xs">{{ related.categories }}</p>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>
{% else %}
<p>No book details available.</p>
{% endif %}
{% endblock %}
